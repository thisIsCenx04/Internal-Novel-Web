1) Nghiệp vụ “xương sống” (rõ luồng, rõ rule)
1.1 Luồng truy cập (Member)

User vào domain → luôn bị guard:

Không có session/token hợp lệ ⇒ redirect /login

Chỉ /login là public

Login:

User nhập username/password

FE gửi kèm deviceId (fingerprint) + userAgent

BE xác thực, áp single-session policy:

KICK_OLD: revoke session cũ, tạo session mới

DENY_NEW: từ chối đăng nhập mới

Trả về access token + refresh token (hoặc 1 session token) và lưu session ACTIVE

Sau login:

Trang Home: header (nút Home), banner nội quy, list 15 truyện mới nhất, footer contact.

Click truyện ⇒ đi thẳng Reader (có chương)

Đọc chương + chống đọc nhanh 10s:

Khi mở chương: BE tạo reading_chapter_sessions (opened_at, allow_next_at = opened_at + 10s)

Khi bấm “Next”:

Nếu now < allow_next_at ⇒ chặn + trả remainingSeconds, tăng counter “bấm quá nhanh”, ghi audit

Nếu đủ thời gian ⇒ cho next chương

VIP:

Rule tại route đọc:

vip_expires_at < now ⇒ chặn đọc và hiển thị “VIP hết hạn”

vip_expires_at - now <= 3 ngày ⇒ hiển thị cảnh báo + (tuỳ chọn) tạo notification

Chống copy (thực tế):

FE chặn select/copy/context menu/hotkeys + watermark username overlay

BE vẫn ghi audit khi client báo “copy attempt” (không thể chống 100% nhưng tăng chi phí & có log)

Các bảng & log/session/reading rule đã thể hiện rất đúng trong schema của bạn (users, user_sessions, reading_chapter_sessions, audit_logs…). 

Db

1.2 Luồng quản trị (Admin Dashboard)

Admin có các module:

A) Thống kê

Tổng view theo ngày/tuần/tháng (từ chapter_views)

Active users (theo session last_seen/heartbeat)

Top truyện nhiều view

B) User

CRUD user

Ban/Unban: ban ⇒ revoke session + chặn login

VIP: set expire date hoặc cộng ngày (admin tùy chỉnh)

C) Truyện & Chương

CRUD story: title/slug/cover/desc/visible

CRUD chapter: chapter_no/content/visible/published_at

“15 truyện mới nhất” dựa latest_chapter_published_at hoặc created_at

D) Settings web

rules_banner_text

footer_contact_text

single_session_policy (KICK_OLD/DENY_NEW)

E) Logs

xem audit logs theo user/action/time

2) Boundary & lớp bảo vệ (BE nên tách rõ)
2.1 Guards / Filters bắt buộc có

Auth filter: mọi route trừ /auth/login, /auth/refresh phải có token/session hợp lệ

Role guard:

/admin/** ⇒ ADMIN

/member/** ⇒ MEMBER hoặc ADMIN

Vip guard:

chỉ áp cho đọc chương (vd: /member/reader/**)

Anti-fast rule:

áp cho API next/prev hoặc API “open chapter” + “next”

Rate limit (khuyến nghị):

chặn spam next-chapter

2.2 Cron/Scheduler (tuỳ chọn nhưng nên có)

Mỗi ngày quét user sắp hết VIP trong 3 ngày ⇒ tạo notification (hoặc làm realtime lúc user vào web)

3) API contracts gợi ý (để FE/BE khớp ngay)

Auth

POST /api/auth/login {username, password, deviceId}

POST /api/auth/logout

POST /api/auth/refresh

Member

GET /api/member/home ⇒ {rulesBannerText, footerContactText, newestStories[15], vipWarning?}

GET /api/member/stories/{slug} ⇒ story meta + list chapter (ẩn/hiện)

POST /api/member/reader/open {chapterId} ⇒ {sessionReadingId, allowNextAt}

POST /api/member/reader/next {sessionReadingId} ⇒ nếu quá nhanh trả 429/400 + remainingSeconds

POST /api/member/audit/copy-attempt {chapterId? storyId?}

Admin

GET /api/admin/dashboard/overview

CRUD /api/admin/users

POST /api/admin/users/{id}/ban

POST /api/admin/users/{id}/unban

POST /api/admin/users/{id}/vip {expiresAt | addDays}

CRUD /api/admin/stories

CRUD /api/admin/stories/{id}/chapters

GET/PUT /api/admin/settings

GET /api/admin/audit-logs?filters...

4) Cấu trúc thư mục chuẩn Spring Boot (khuyến nghị theo module)

Giả sử base package: com.noelreading

backend/
├─ pom.xml
├─ src/main/java/com/novelweb/
│  ├─ NovelWebInternalReadingApplication.java
│  ├─ common/
│  │  ├─ exception/
│  │  │  ├─ ApiException.java
│  │  │  ├─ GlobalExceptionHandler.java
│  │  ├─ response/
│  │  │  ├─ ApiResponse.java
│  │  │  ├─ PageResponse.java
│  │  ├─ utils/
│  │  │  ├─ SlugUtil.java
│  │  │  ├─ TimeUtil.java
│  │  └─ constants/
│  │     ├─ SecurityConstants.java
│  │     └─ CacheKeys.java
│  │
│  ├─ config/
│  │  ├─ SecurityConfig.java
│  │  ├─ CorsConfig.java
│  │  ├─ WebConfig.java
│  │  ├─ SchedulerConfig.java
│  │  └─ JpaConfig.java
│  │
│  ├─ security/
│  │  ├─ jwt/
│  │  │  ├─ JwtProvider.java
│  │  │  ├─ JwtAuthFilter.java
│  │  │  └─ JwtAuthenticationEntryPoint.java
│  │  ├─ auth/
│  │  │  ├─ CurrentUser.java
│  │  │  ├─ CurrentUserArgumentResolver.java
│  │  │  └─ SecurityUserDetails.java
│  │  └─ rate_limit/
│  │     └─ RateLimitFilter.java   (optional)
│  │
│  ├─ modules/
│  │  ├─ auth/
│  │  │  ├─ AuthController.java
│  │  │  ├─ AuthService.java
│  │  │  ├─ dto/
│  │  │  │  ├─ LoginRequest.java
│  │  │  │  ├─ LoginResponse.java
│  │  │  │  └─ RefreshRequest.java
│  │  │  └─ session/
│  │  │     ├─ SessionService.java
│  │  │     ├─ SessionRepository.java
│  │  │     └─ policy/
│  │  │        ├─ SingleSessionPolicy.java
│  │  │        ├─ KickOldPolicy.java
│  │  │        └─ DenyNewPolicy.java
│  │  │
│  │  ├─ users/
│  │  │  ├─ UserAdminController.java
│  │  │  ├─ UserService.java
│  │  │  ├─ UserRepository.java
│  │  │  ├─ dto/
│  │  │  │  ├─ UserCreateRequest.java
│  │  │  │  ├─ UserUpdateRequest.java
│  │  │  │  └─ VipUpdateRequest.java
│  │  │  └─ mapper/
│  │  │     └─ UserMapper.java
│  │  │
│  │  ├─ stories/
│  │  │  ├─ StoryAdminController.java
│  │  │  ├─ StoryMemberController.java
│  │  │  ├─ StoryService.java
│  │  │  ├─ StoryRepository.java
│  │  │  ├─ dto/
│  │  │  └─ mapper/
│  │  │
│  │  ├─ chapters/
│  │  │  ├─ ChapterAdminController.java
│  │  │  ├─ ChapterMemberController.java
│  │  │  ├─ ChapterService.java
│  │  │  ├─ ChapterRepository.java
│  │  │  └─ dto/
│  │  │
│  │  ├─ reader/
│  │  │  ├─ ReaderController.java
│  │  │  ├─ ReadingRuleService.java      (rule 10s)
│  │  │  ├─ ReadingSessionRepository.java
│  │  │  ├─ ViewTrackingService.java     (chapter_views)
│  │  │  └─ dto/
│  │  │
│  │  ├─ settings/
│  │  │  ├─ SettingsAdminController.java
│  │  │  ├─ SettingsService.java
│  │  │  └─ SettingsRepository.java
│  │  │
│  │  ├─ notifications/
│  │  │  ├─ NotificationController.java
│  │  │  ├─ NotificationService.java
│  │  │  ├─ NotificationRepository.java
│  │  │  └─ scheduler/
│  │  │     └─ VipNotifyJob.java
│  │  │
│  │  ├─ dashboard/
│  │  │  ├─ DashboardController.java
│  │  │  └─ DashboardService.java
│  │  │
│  │  └─ audit/
│  │     ├─ AuditAdminController.java
│  │     ├─ AuditService.java
│  │     └─ AuditRepository.java
│  │
│  ├─ domain/
│  │  ├─ entity/
│  │  │  ├─ User.java
│  │  │  ├─ UserSession.java
│  │  │  ├─ Story.java
│  │  │  ├─ Chapter.java
│  │  │  ├─ ChapterView.java
│  │  │  ├─ ReadingChapterSession.java
│  │  │  ├─ SiteSetting.java
│  │  │  ├─ Notification.java
│  │  │  └─ AuditLog.java
│  │  └─ enums/
│  │     ├─ UserRole.java
│  │     ├─ UserStatus.java
│  │     └─ ...
│  │
│  └─ infra/
│     ├─ db/
│     │  ├─ migration/         (Flyway/Liquibase)
│     │  └─ seed/
│     └─ storage/              (nếu sau này có upload cover)
│
├─ src/main/resources/
│  ├─ application.yml
│  ├─ db/migration/
│  │  ├─ V1__init.sql
│  │  └─ ...
│  └─ logback-spring.xml
└─ src/test/java/...


Điểm quan trọng:

domain/entity giữ entity thuần (JPA)

modules/* tách theo nghiệp vụ (auth/users/stories/reader/…) ⇒ dễ maintain

security/* tách riêng auth filter/JWT/rate limit

DB migration đưa vào db/migration (Flyway) để deploy Railway dễ (bạn đã có schema SQL rất đầy đủ). 

Db

5) Cấu trúc thư mục chuẩn ReactJS (Member + Admin cùng 1 app)

Mình gợi ý 1 codebase với route /admin/* và /app/* (member), chia theo features:

frontend/
├─ package.json
├─ vite.config.ts (hoặc CRA)
├─ src/
│  ├─ main.tsx
│  ├─ app/
│  │  ├─ router.tsx
│  │  ├─ providers/
│  │  │  ├─ AuthProvider.tsx
│  │  │  └─ QueryProvider.tsx (react-query)
│  │  ├─ layouts/
│  │  │  ├─ AuthLayout.tsx
│  │  │  ├─ MemberLayout.tsx
│  │  │  └─ AdminLayout.tsx
│  │  └─ guards/
│  │     ├─ RequireAuth.tsx
│  │     ├─ RequireRole.tsx
│  │     └─ RequireVip.tsx
│  │
│  ├─ features/
│  │  ├─ auth/
│  │  │  ├─ pages/LoginPage.tsx
│  │  │  ├─ api/authApi.ts
│  │  │  ├─ hooks/useAuth.ts
│  │  │  └─ utils/deviceId.ts   (fingerprint/cookie)
│  │  │
│  │  ├─ member/
│  │  │  ├─ pages/HomePage.tsx
│  │  │  ├─ pages/ReaderPage.tsx
│  │  │  ├─ components/
│  │  │  │  ├─ Header.tsx
│  │  │  │  ├─ Footer.tsx
│  │  │  │  ├─ RulesBanner.tsx
│  │  │  │  ├─ StoryCard.tsx
│  │  │  │  └─ ChapterReader.tsx
│  │  │  ├─ api/memberApi.ts
│  │  │  └─ anti/
│  │  │     ├─ antiCopy.ts      (block events)
│  │  │     └─ watermark.tsx    (overlay username)
│  │  │
│  │  ├─ admin/
│  │  │  ├─ pages/DashboardPage.tsx
│  │  │  ├─ pages/UsersPage.tsx
│  │  │  ├─ pages/StoriesPage.tsx
│  │  │  ├─ pages/ChaptersPage.tsx
│  │  │  ├─ pages/SettingsPage.tsx
│  │  │  ├─ pages/AuditLogsPage.tsx
│  │  │  ├─ components/
│  │  │  │  ├─ StatCards.tsx
│  │  │  │  ├─ UserTable.tsx
│  │  │  │  ├─ StoryForm.tsx
│  │  │  │  └─ ChapterForm.tsx
│  │  │  └─ api/adminApi.ts
│  │  │
│  │  └─ notifications/
│  │     ├─ components/NotificationBell.tsx
│  │     └─ api/notificationApi.ts
│  │
│  ├─ shared/
│  │  ├─ api/
│  │  │  ├─ httpClient.ts     (axios instance + interceptors)
│  │  │  │  └─ tokenStore.ts  (localStorage/cookie)
│  │  ├─ components/
│  │  │  ├─ Button.tsx
│  │  │  ├─ Modal.tsx
│  │  │  ├─ Table.tsx
│  │  │  └─ Toast.tsx
│  │  ├─ hooks/
│  │  ├─ types/
│  │  └─ utils/
│  │
│  └─ styles/
│     └─ global.css
└─ .env

FE notes quan trọng (đúng yêu cầu “bắt buộc login”)

Router: mọi route (trừ /login) bọc RequireAuth

RequireRole('ADMIN') cho /admin/*

Reader page bọc RequireVip (nếu bạn chọn chặn đọc khi hết VIP)

Anti-copy: đặt trong ChapterReader mount/unmount (để không phá UI admin)

6) Mapping nhanh “module ↔ bảng DB” (để dev không lạc)

Auth/Session ↔ users, user_sessions, audit_logs

Stories/Chapters ↔ stories, chapters 

Reader protection ↔ reading_chapter_sessions, chapter_views, audit_logs 

VIP notify ↔ users.vip_expires_at, notifications 

Settings web ↔ site_settings 

0) Module nền tảng (Foundation)

BE

Setup project, env, cấu hình DB (Postgres), Flyway/Liquibase migration

Base response + global exception handler

Logging + audit base
FE

Setup React (Vite), router, layout, state (React Query/Redux), axios client + refresh token

UI kit cơ bản (table, modal, toast)

Deliverables

Chạy local end-to-end (FE gọi BE hello/auth ping)

Migration chạy 1 phát tạo schema

1) Auth & Session (bắt buộc login + 1 tài khoản/1 thiết bị)

BE

Login/logout/refresh

Single-session policy: KICK_OLD hoặc DENY_NEW

Session storage + revoke

Middleware auth guard + role guard
FE

Trang Login

Token store + auto refresh

RequireAuth + RequireRole guards

Tạo/lưu deviceId (fingerprint/cookie)

Deliverables

Không login không vào được Home/Reader/Admin

Đăng nhập thiết bị 2 xử lý đúng policy

2) Settings Website (banner nội quy + footer contact + policy)

BE

CRUD settings (admin)

API public/member trả về rules/footer
FE

Hiển thị banner nội quy + footer contact

Admin Settings page chỉnh sửa

Deliverables

Admin sửa text ⇒ member thấy thay đổi realtime sau refresh

3) Stories (Truyện) Module

BE

CRUD truyện: title/slug/cover/desc/visible

API member: list newest 15, story detail
FE

Home: Top 15 newest

Story card + story detail (list chapter)

Admin: list + create/edit/hide/show

Deliverables

Thêm truyện ở admin ⇒ xuất hiện trong member (theo visible)

4) Chapters (Chương) Module

BE

CRUD chapter theo story: chapter_no, title, content, visible, published_at

API member: lấy chapter theo slug + chapterNo/id
FE

Admin: editor tạo/sửa chương

Member: hiển thị danh sách chương + mở chương

Deliverables

Truyện có phân chương, truy cập chương ổn định

5) Reader Protection (chống đọc nhanh 10s + chống copy)

BE

open chapter tạo reading session (allow_next_at = now + 10s)

next chapter check allow_next_at, trả remainingSeconds nếu vi phạm

Ghi view (chapter_views) + audit (rapid click/copy attempt)
FE

Reader UI: Open → đọc → Next/Prev

Nếu bị chặn 10s: hiển thị countdown/disable nút

Anti-copy: chặn select/copy/contextmenu/hotkeys + watermark username

Deliverables

Next trước 10s bị chặn đúng, log được

Copy bị hạn chế + có audit event

6) VIP & User Lifecycle (VIP days, cảnh báo 3 ngày, ban/unban)

BE

User CRUD + ban/unban (ban ⇒ revoke session)

VIP: set expiresAt hoặc addDays

API member trả vipWarning khi còn ≤ 3 ngày / hết hạn chặn đọc

(Tuỳ chọn) Scheduler tạo notifications sắp hết VIP
FE

Admin Users: CRUD + ban/unban + set VIP

Member: hiển thị cảnh báo VIP (banner/toast)

Reader: hết VIP ⇒ chặn đọc + thông báo

Deliverables

Logic VIP đúng, ban/unban có hiệu lực ngay

7) Dashboard & Analytics (thống kê view, user)

BE

Tổng views theo ngày/tuần/tháng

Active users theo session

Top stories/views
FE

Admin dashboard page: stat cards + chart/table

Deliverables

Dashboard có số liệu thật từ DB

8) Audit Logs (theo dõi hành vi)

BE

Ghi audit cho login, logout, ban/unban, vip update, rapid click, copy attempt

Admin API filter logs
FE

Admin audit page: lọc theo user/action/date

Deliverables

Truy vết được mọi hành vi quan trọng

9) DevOps/Deployment (Railway)

BE

Dockerfile, env vars, health check

Auto migrate Flyway khi deploy
FE

Build static + deploy (Railway/Netlify/Vercel tùy bạn)
Deliverables

Deploy chạy ổn, migration tự lên schema